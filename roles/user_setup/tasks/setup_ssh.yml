---
# roles/user_setup/tasks/setup_ssh.yml

- name: Set home_dir for the user
  set_fact:
    home_dir: "{{ user_item.home | default('/home/' + user_item.username) }}"

# Ensure home exists (user module earlier usually does this; safe check)
- name: Ensure user home exists
  file:
    path: "{{ home_dir }}"
    state: directory
    owner: "{{ user_item.username }}"
    group: "{{ user_item.username }}"
    mode: '0755'

# Ensure ~/.ssh exists and is owned by the user (run as root to avoid temp-file perms problems)
- name: Ensure .ssh directory exists
  file:
    path: "{{ home_dir }}/.ssh"
    state: directory
    owner: "{{ user_item.username }}"
    group: "{{ user_item.username }}"
    mode: '0700'

# Generate an SSH keypair if it doesn't already exist (idempotent)
- name: Generate SSH keypair for user (idempotent)
  openssh_keypair:
    path: "{{ home_dir }}/.ssh/id_{{ ssh_key_type | default('ed25519') }}"
    type: "{{ ssh_key_type | default('ed25519') }}"
    owner: "{{ user_item.username }}"
    group: "{{ user_item.username }}"
    mode: '0600'
  register: ssh_key_result

# Add key to ssh-agent (only when actually changed and not in check mode)
- name: Add key to ssh-agent (only when key created)
  become_user: "{{ user_item.username }}"
  shell: |
    eval "$(ssh-agent -s)"
    ssh-add "{{ home_dir }}/.ssh/id_{{ ssh_key_type | default('ed25519') }}"
  args:
    executable: /bin/bash
  when:
    - ssh_key_result.changed
    - not ansible_check_mode

# Optionally upload key to GitHub (only if token present and not in check mode)
- name: Upload SSH public key to GitHub (if token provided)
  become_user: "{{ user_item.username }}"
  shell: |
    echo "$GH_TOKEN" | gh auth login --with-token
    gh ssh-key add "{{ home_dir }}/.ssh/id_{{ ssh_key_type | default('ed25519') }}.pub" --title "{{ inventory_hostname }}"
  environment:
    GH_TOKEN: "{{ user_item.github_token | default('') }}"
  when:
    - user_item.github_token is defined
    - user_item.github_token | length > 0
    - not ansible_check_mode
